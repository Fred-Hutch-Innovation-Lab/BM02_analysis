---
title: 'SC processing'
author: "FHIL\nDerrikGratz"
date: '`r Sys.Date()`'
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.width = 8, fig.height = 6,
                      cache=FALSE, cache.lazy = FALSE) 

library(tidyverse)  ## General R logic
library(here)       ## Easier specification of file locations
library(yaml)       ## parses config yaml
library(Seurat)
library(reshape2)   ## DF manipulation
# library(clustree)   ## Resolution selection for clustering
# library(ggraph)     ## To render clustree
library(bluster)     ## Sihouette scores
library(SingleR)    ## reference based annotation
library(ggforestplot) ## Striped lines for dotplots
library(SingleCellExperiment)
library(gridExtra)  ## arrange plots
library(janitor) ## Tabyl, adorn_rounding
library(ggrastr) ## Rasterize images for smaller size
rbindlist <- data.table::rbindlist
set.seed(33)
```

# Functions

```{r}
add_suffix_to_duplicates <- function(vec) {
  counts <- ave(seq_along(vec), vec, FUN = seq_along)
  vec[counts > 1] <- paste0(vec[counts > 1], "_", counts[counts > 1])
  return(vec)
}
```


# Load data

```{r}
objs <- readRDS(here('rds/03-objs_post_gene_filtering.rds'))
metadata <- read.csv(here('config/metadata.csv'))
figures <- list()
```

# Data normalization and processing

```{r}
# objs <- lapply(objs, NormalizeData)
objs <- lapply(objs, FindVariableFeatures)
objs <- lapply(objs, ScaleData)
objs <- lapply(objs, RunPCA)
```

```{r}
#Check if 20 dims is appropriate
lapply(objs, ElbowPlot, ndim=30)
```

```{r}
objs <- lapply(objs, FindNeighbors, dims=1:20, return.neighbor=TRUE)
objs <- lapply(objs, FindNeighbors, dims=1:20, return.neighbor=FALSE)
objs <- lapply(objs, RunUMAP, nn.name='RNA.nn')#dims=1:20)
```

```{r}
lapply(objs, DimPlot)
```


# Reference annotation

```{r run_SingleR}
runSingleR <- function(obj.seurat,
                       ref,
                       labels,
                       de.method = "classic",
                       meta.prefix = 'singleR',
                       num.threads = BiocParallel::bpnworkers(BiocParallel::MulticoreParam()),
                       ...) {
  singleR.out <- obj.seurat %>%
    Seurat::as.SingleCellExperiment(assay = "RNA") %>%
    scuttle::logNormCounts() %>%
    SummarizedExperiment::assays() # %>%
    # .$logcounts %>%
  singleR.out <- SingleR::SingleR(test = singleR.out$logcounts,
                     ref = ref,
                     labels = labels,
                     de.method = de.method,
                     num.threads = num.threads,
                     ...)

  obj.seurat@meta.data[[paste0(meta.prefix,".labels")]] <- singleR.out$labels
  obj.seurat@meta.data[[paste0(meta.prefix,".pruned.labels")]] <- singleR.out$pruned.labels
  obj.seurat@meta.data[[paste0(meta.prefix,".delta.next")]] <- singleR.out$delta.next

  return(obj.seurat)
}
```

## Novershtern

```{r}
ref <- readRDS('/fh/fast/_IRC/FHIL/pub/ref/single_cell_references/Novershtern_celldex.rds')
objs <- lapply(objs, function(x) {
  runSingleR(x, 
             ref = assays(ref)$logcounts,
             labels = ref$label.main,
             meta.prefix = 'Novershtern.main',
             de.method = 'wilcox')
  })
```

## HPCA

```{r}
ref <- readRDS('/fh/fast/_IRC/FHIL/pub/ref/single_cell_references/HPCA_celldex.rds')
objs <- lapply(objs, function(x) {
  runSingleR(x, 
             ref = assays(ref)$logcounts,
             labels = ref$label.main,
             meta.prefix = 'HPCA.main',
             de.method = 'wilcox')
  })
```

# Fixed resolution

```{r}
objs <- lapply(objs, FindClusters, resolution=1.0, cluster.name='res_1.0_clusters') #, algorithm=4
```

```{r}
lapply(objs, DimPlot)
```

# Explore resolutions

## Seurat louvain

```{r}
res_selection <- function(obj,
                          seqs=c(seq(0.01,0.05, 0.01), 
                                 seq(0.1,0.4,0.05),
                                 seq(0.5,1, .1), 
                                 c(1.2, 1.4, 1.6, 1.8, 2)),
                          ndim=20) {
  x <- list()
  print('Next iter')
  for (res in seqs) {
    print(res)
    clus <- FindClusters(obj, resolution = res, verbose = FALSE)$seurat_clusters
    nclus <- length(levels(clus))
    if (nclus == 0) {
      avg_sil <- NA
      avg_pur <- NA
    } else {
      avg_sil <- approxSilhouette(obj@reductions$pca@cell.embeddings[,1:ndim], clus)$width %>% mean()
      avg_pur <- neighborPurity(obj@reductions$pca@cell.embeddings[,1:ndim], clus)$purity %>% mean()
    }
    x[[paste0('res_', res)]] <- list(avg_sil=avg_sil, avg_pur=avg_pur, nclus=nclus, joint=avg_sil + avg_pur)  
    if (nclus > 20) {
      break
    }
  }
  x <- data.table::rbindlist(x) %>%
    as.data.frame()
  x[['rank_sil']] <- data.table::frankv(x, 'avg_sil', order=-1)
  x[['rank_pur']] <- data.table::frankv(x, 'avg_pur', order=-1)
  x <- x %>% mutate(rank = (rank_sil + rank_pur) /2)
  x$resolution <- seqs[1:match(res, seqs)]
  x 
}
```

```{r}
res_table <- lapply(objs, res_selection)
```


## Bluster ?

```{r, eval=FALSE}
leiden_sweep <- function(obj, resolutions = c(seq(0.001, 0.01, 0.001), seq(0.015, 0.05, 0.005), seq(0.06, 0.1, 0.01)), ndim=20) {
  pca <- obj@reductions$pca@cell.embeddings[,1:ndim]
  res <- clusterSweep(pca, BLUSPARAM = NNGraphParam(cluster.fun = 'leiden'), cluster.args=list(resolution_parameter=resolutions))
  sil <- vapply(as.list(res$clusters), function(x) mean(approxSilhouette(pca, x)$width), 0)
  cbind(nclus = unname(apply(res$clusters, MARGIN = 2, function(x) length(unique(x)))),
        resolution = unname(unlist(res$parameters$cluster.args)),
        sil = unname(sil))
}

leiden_sweep_res <- lapply(objs, leiden_sweep)
```

## Optimal resolution

```{r}
figures[['Sample_level_umaps']] <- list()

for (kit in unique(metadata$Kit)) {
  figures[['Sample_level_umaps']][[kit]] <- list()
  for (sample in metadata$Sample[metadata$Kit == kit]) {
    res <- res_table[[sample]]
    res <- res %>%
      filter(nclus > 10)
    res <- res[which.max(res$avg_sil),]
    print(paste0(sample, ': res ', res$resolution, '; nclus=', res$nclus, '; sil: ', res$avg_sil))
    objs[[sample]] <- FindClusters(objs[[sample]], resolution = res$resolution, verbose = FALSE)
    figures[['Sample_level_umaps']][[kit]][[sample]] <- DimPlot(objs[[sample]], group.by='seurat_clusters', label=TRUE,
                                                                raster = TRUE, raster.dpi = c(512, 512)) + ggtitle(sample)
  }
}
```

# Annotation cluster overlap

## Dimplots

```{r, fig.width=18, fig.height=5}
figures[['annotation_overlays_nove']] <- list()
for (kit in unique(metadata$Kit)) {
  figures[['annotation_overlays_nove']][[kit]] <- list()
  for (sample in metadata$Sample[metadata$Kit == kit]) {
    p1 <- DimPlot(objs[[sample]], group.by="seurat_clusters", label = TRUE, raster = TRUE, raster.dpi = c(512, 512))
    p2 <- DimPlot(objs[[sample]], group.by="Novershtern.main.pruned.labels", raster = TRUE, raster.dpi = c(512, 512) , label = TRUE)
    p3 <- FeaturePlot(objs[[sample]], "Novershtern.main.delta.next", raster = TRUE, raster.dpi = c(512, 512))
    figures[['annotation_overlays_nove']][[kit]][[sample]] <- list(p1, p2, p3)
  }
}
grid.arrange(grobs=figures[['annotation_overlays_nove']][['Fluent']]$FB_2_F1A, nrow=1)
```

```{r}
figures[['annotation_overlays_hpca']] <- list()
for (kit in unique(metadata$Kit)) {
  figures[['annotation_overlays_hpca']][[kit]] <- list()
  for (sample in metadata$Sample[metadata$Kit == kit]) {
    p1 <- DimPlot(objs[[sample]], group.by="seurat_clusters", raster = TRUE, raster.dpi = c(512, 512), label = TRUE)
    p2 <- DimPlot(objs[[sample]], group.by="HPCA.main.pruned.labels", raster = TRUE, raster.dpi = c(512, 512), label = TRUE)
    p3 <- FeaturePlot(objs[[sample]], "HPCA.main.delta.next", raster = TRUE, raster.dpi = c(512, 512))
    figures[['annotation_overlays_hpca']][[kit]][[sample]] <- list(p1, p2, p3)
  }
}
figures[['annotation_overlays_hpca']][['Fluent']]
```

## Tables

```{r}
summarize_annotations <- function(obj, annotation_prefix, cluster_column='seurat_clusters') {
  annotation_col <- paste0(annotation_prefix, '.pruned.labels')
  score_col <- paste0(annotation_prefix, '.delta.next')
  obj@meta.data %>%
    group_by(.data[[cluster_column]], .data[[annotation_col]]) %>%
    summarize(
      n = n(),
      median_score = median(.data[[score_col]]), .groups = 'keep'
    ) %>%
    arrange(.data[[cluster_column]], desc(n)) %>%
    group_by(.data[[cluster_column]]) %>%
    mutate(percentage = n / sum(n)) %>%
    summarize(
      first_annotation = dplyr::first(.data[[annotation_col]]),
      first_annotation_percentage = dplyr::first(percentage) * 100,
      first_annotation_median_score = dplyr::first(median_score),
      second_annotation = dplyr::nth(.data[[annotation_col]], 2),
      second_annotation_percentage = dplyr::nth(percentage, 2) * 100,
      second_annotation_median_score = dplyr::nth(median_score, 2)
    )
}
```


```{r}
hpca_annotations <- lapply(objs, summarize_annotations, annotation_prefix = 'HPCA.main') 
nove_annotations <- lapply(objs, summarize_annotations, annotation_prefix = 'Novershtern.main') 
hpca_annotations$Flex_F1A |> 
  janitor::adorn_rounding(digits = 2)

nove_annotations$Flex_F1A |> 
  janitor::adorn_rounding(digits = 2) 
```

# Marker genes

```{r}
celltype_markers <- read.csv('/fh/fast/_IRC/FHIL/grp/FHIL_knowledgebase/biology/celltype_markers.csv')

parse_marker_table <- function(celltype_dataframe) {
  celltype_dataframe %>%
    filter(expression_level == 'Increased' & tissue == 'PBMC') %>%
    filter(confidence != 'low') %>%
    filter(celltype %in% c('T', 'B', 'Monocyte', 'NK', 'Dendritic', 'Neutrophil')) %>%
    select(gene_symbol, celltype) %>%
    unstack()
}

prune_marker_list <- function(input_list) {
  all_items <- unlist(input_list, use.names = TRUE)
  dup_items <- names(table(all_items))[table(all_items) > 1]
  input_list_cleaned <- lapply(input_list, function(x) setdiff(x, dup_items))
  
  new_groups <- sapply(dup_items, function(item) {
    found_in <- names(input_list)[sapply(input_list, function(x) item %in% x)]
    new_group_name <- paste(found_in, collapse = " &\n")
    return(new_group_name)
  }, USE.NAMES = TRUE)
  
  new_list <- input_list_cleaned  
  for (i in seq_along(dup_items)) {
    new_list[[new_groups[i]]] <- c(new_list[[new_groups[i]]], dup_items[i])
  }
  
  wrap_name <- function(name) {
    wrapped_name <- strwrap(name, width = 10, simplify = TRUE)
    wrapped_name <- paste(wrapped_name, collapse = "\n")
    return(wrapped_name)
  }
  
  names(new_list) <- sapply(names(new_list), wrap_name)# {
  new_list
}

celltype_markers <- parse_marker_table(celltype_markers)
celltype_markers <- prune_marker_list(celltype_markers)
```

```{r, fig.width=40, fig.height=12}
figures$marker_dotplots <- lapply(objs, function(x) {
  DotPlot(x, celltype_markers) + 
    theme_grey() +
    geom_stripes()
})
figures$marker_dotplots$Flex_F1A
```

# Final annotations

## Flex

### F1A

```{r}
samplename <- 'Flex_F1A'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "T",
      "T",
      "T", #5
      "NK",
      "Monocyte",
      "T",
      "B",
      "B", #10
      "Dendritic",
      "Unknown", 
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'Flex_F1B'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "T",
      "T",
      "T", #5
      "Monocyte",
      "NK",
      "T",
      "B",
      "B", #10
      "T",
      "Dendritic",
      "Platelet",
      "Unknown"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'Flex_F5A'
cell_labels <- c(
      "T", #0
      "B",
      "Monocyte",
      "T",
      "NK",
      "T", #5
      "T",
      "T",
      "T",
      "T",
      "Dendritic", #10
      "Platelet",
      "Unknown"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'Flex_F5B'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "NK",
      "T",
      "T",
      "T", #5
      "B", 
      "T",
      "B",
      "T",
      "T", #10
      "Monocyte",
      "Dendritic",
      "Platelet",
      "Unknown",
      "Unknown" #15
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

## Fluent

### F1A

```{r}
samplename <- 'FB_2_F1A'
cell_labels <- c(
      "T", #0
      "T",
      "T",
      "T",
      "T",
      "T", #5
      "T",
      "NK",
      "T",
      "Monocyte",
      "B", #10
      "B",
      "Monocyte",
      "T",
      "T",
      "Dendritic", #15
      "Unknown",
      "Unknown",
      "Unknown"
)
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'FB_2_F1B'
annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = c(
      "T", #0
      "T",
      "T",
      "B",
      "Monocyte",
      "T", #5
      "T",
      "T?",
      "NK",
      "Monocyte",
      "Unknown", #10
      "Dendritic",
      "Dendritic"
    )
  )
objs[[samplename]]$annotations <- annotations
objs[[samplename]]$cell_labels <- gsub('(.+)(\\s+\\d+)', '\\1', annotations)
DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'FB_2_F5A'
cell_labels <- c(
      "T", #0
      "T",
      "T",
      "NK",
      "B",
      "Monocyte", #5
      "T",
      "Unknown",
      "Monocyte",
      "T",
      "Dendritic", #10
      "Dendritic"
)
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'FB_2_F5B'
cell_labels <- c(
      "T", #0
      "T",
      "NK",
      "B",
      "T",
      "Monocyte", #5
      "T",
      "T",
      "NK",
      "Dendritic",
      "Monocyte",#10
      "Dendritic" 
)

objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

## NextGEM

### F1A

```{r}
samplename <- 'NextGEM3P_F1A'
cell_labels <- c(
      "T", #0
      "T",
      "T",
      "Monocyte",
      "T",
      "Monocyte", #5
      "NK",
      "B",
      "B",
      "T",
      "Dendritic", #10
      "T?",
      "Unknown"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'NextGEM3P_F1B'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "T",
      "B",
      "T", #5
      "NK",
      "Monocyte",
      "T",
      "T",
      "Dendritic", #10
      "T",
      "Unknown",
      "Unknown"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'NextGEM3P_F5A'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "B",
      "NK",
      "T", #5
      "T",
      "T",
      "T",
      "Monocyte",
      "Dendritic", #10
      "T",
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'NextGEM3P_F5B'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "NK",
      "T",
      "T", #5
      "B",
      "T",
      "B",
      "T",
      "T", #10
      "T/NK",
      "Monocyte",
      "Dendritic",
      "T?",
      "NK", #15
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

## GEMX

### F1A

```{r}
samplename <- 'GEMX3P_F1A'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "T",
      "T",
      "T", #5
      "T",
      "B",
      "B",
      "Monocyte",
      "NK", #10
      "T",
      "Monocyte",
      "T",
      "Unknown",
      "T", #15
      "T", 
      "T",
      "B",
      "Dendritic",
      "Unknown", # 20
      "T",
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'GEMX3P_F1B'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "T",
      "T",
      "T", #5
      "NK",
      "B",
      "B",
      "Monocyte",
      "T", #10
      "?",
      "Monocyte",
      "Dendritic",
      "?",
      "Dendritic" #15
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'GEMX3P_F5A'
cell_labels <- c(
      "T", #0
      "B",
      "Monocyte",
      "T",
      "NK",
      "T", #5
      "T",
      "T",
      "T",
      "T",
      "Monocyte", #10
      "Dendritic",
      "?",
      "NK",
      "?",
      "?"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'GEMX3P_F5B'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "T",
      "NK",
      "T",
      "B", #5
      "T",
      "T",
      "T",
      "B",
      "T", #10
      "T",
      "B",
      "Monocyte",
      "Platelet?",
      "Dendritic", #15
      "NK",
      "NK",
      "Dendritic",
      "?"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

## Parse

### F1A

```{r}
samplename <- 'PA_V3_F1A'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "NK/T",
      "T",
      "Monocyte", #5
      "NK",
      "T",
      "B",
      "B",
      "T", #10
      "Dendritic",
      "?"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'PA_V3_F1B'
cell_labels <- c(
      "T", #0
      "T",
      "Monocyte",
      "NK/T",
      "B",
      "T", #5
      "Monocyte",
      "NK",
      "T",
      "Dendritic",
      "Dendritic" #10
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'PA_V3_F5A'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "T",
      "B",
      "NK/T",
      "T", #5
      "NK",
      "T",
      "T",
      "T",
      "Monocyte", #10
      "Dendritic",
      "NK"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'PA_V3_F5B'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "T",
      "B",
      "T",
      "NK", #5
      "NK/T",
      "T",
      "T",
      "T",
      "Neutrophil?", #10
      "Dendritic",
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

## Scale

### F1A

```{r}
samplename <- 'Scale_F1A'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "B",
      "T",
      "T/NK?",
      "NK", #5
      "T",
      "T",
      "T",
      "T",
      "Dendritic", #10
      "Neutrophil?",
      "Dendritic",
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F1B

```{r}
samplename <- 'Scale_F1B'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "T",
      "T",
      "T",
      "Monocyte", #5
      "B",
      "B",
      "NK",
      "T",
      "T", #10
      "T",
      "T",
      "Monocyte",
      "Dendritic",
      "Neutrophil", #15
      'Dendritic'
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5A

```{r}
samplename <- 'Scale_F5A'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "T",
      "T",
      "B",
      "T", #5
      "NK",
      "T",
      "Neutrophil",
      "T",
      "T", #10
      "T",
      "Neutrophil",
      "Dendritic",
      "Neutrophil"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

### F5B

```{r}
samplename <- 'Scale_F5B'
cell_labels <- c(
      "T", #0
      "Monocyte",
      "B",
      "T",
      "T",
      "T", #5
      "NK",
      "T",
      "T",
      "T",
      "Neutrophil", #10
      "Dendritic",
      "Dendritic"
    )
objs[[samplename]]$cell_labels <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = cell_labels
  )

objs[[samplename]]$annotations <- 
  plyr::mapvalues(
    x = objs[[samplename]]$seurat_clusters,
    from = levels(objs[[samplename]]$seurat_clusters),
    to = add_suffix_to_duplicates(cell_labels)
  )

DimPlot(objs[[samplename]], group.by = 'annotations', label=TRUE)
DimPlot(objs[[samplename]], group.by = 'cell_labels', label=TRUE)
```

# Save objs

```{r}
saveRDS(objs, here('rds/04_objs_post_clustering.rds'), compress=FALSE)
```

# Render report

```{r, eval=TRUE}
## This only works if all the variables called in the format file 
## are in the current environment. Check the format file to tweak
## aesthetics 
rmarkdown::render(here('processing_scripts/04-clustering.format.Rmd'),
                  output_file = '04-clustering.html',
                  output_dir = here('reports'))
```
